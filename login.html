<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Sign Up - HopeLink Mahama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .auth-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .form-input {
            transition: all 0.3s ease;
        }
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.3);
        }
        .tab-active {
            background: linear-gradient(135deg, #3B82F6, #10B981);
            color: white;
        }
        .password-strength {
            height: 4px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }
        .success-message {
            background-color: #efe;
            border: 1px solid #cfc;
            color: #363;
        }
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10B981;
        }
        .notification.error {
            background-color: #EF4444;
        }
        .admin-badge {
            background: linear-gradient(135deg, #FF6B6B, #FFE66D);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .user-badge {
            background: linear-gradient(135deg, #3B82F6, #10B981);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="font-sans">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 p-2 rounded-lg mr-3">
                        <i class="fas fa-hands-helping text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-xl text-gray-800">HopeLink</div>
                        <div class="text-xs text-green-500 font-semibold">Mahama Refugee Camp</div>
                    </div>
                </div>
                <a href="index.html" class="text-blue-500 hover:text-blue-600 transition flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Home
                </a>
            </div>
        </div>
    </nav>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="flex items-center">
            <i id="notificationIcon" class="fas fa-check-circle mr-2"></i>
            <span id="notificationMessage">Action completed successfully!</span>
        </div>
    </div>

    <!-- Authentication Section -->
    <div class="auth-container pt-20">
        <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="auth-card w-full max-w-md">
                <div class="p-8">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200 mb-8">
                        <button id="login-tab" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-blue-500 transition tab-active rounded-tl-lg">
                            Sign In
                        </button>
                        <button id="signup-tab" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-blue-500 transition rounded-tr-lg">
                            Sign Up
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="login-form-container" class="fade-in">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Welcome Back</h2>
                        <p class="text-gray-600 text-center mb-8">Sign in to your HopeLink account</p>

                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="login-email" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2">Password</label>
                                <input type="password" id="login-password" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-600">Remember me</span>
                                </label>
                                <button type="button" id="forgot-password-btn" class="text-blue-500 hover:text-blue-600 text-sm">
                                    Forgot password?
                                </button>
                            </div>
                            </div>

                            <div id="login-error" class="hidden error-message p-3 rounded-md"></div>
                            <div id="login-success" class="hidden success-message p-3 rounded-md"></div>

                            <button type="submit" class="w-full bg-blue-500 text-white py-4 rounded-lg font-semibold hover:bg-blue-600 transition transform hover:scale-105 flex items-center justify-center">
                                <span id="login-button-text">Sign In</span>
                                <div id="login-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <!-- Social Login -->
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">Or continue with</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" id="google-login-btn" 
                                        class="p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                                    <i class="fab fa-google text-red-500 mr-2"></i>
                                    Google
                                </button>
                                <button type="button" id="github-login-btn" 
                                        class="p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                                    <i class="fab fa-github text-gray-800 mr-2"></i>
                                    GitHub
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div id="signup-form-container" class="hidden fade-in">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Create Account</h2>
                        <p class="text-gray-600 text-center mb-8">Join HopeLink community today</p>

                        <form id="signupForm" class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">First Name</label>
                                    <input type="text" id="signup-firstname" required 
                                           class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">Last Name</label>
                                    <input type="text" id="signup-lastname" required 
                                           class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="signup-email" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div id="role-indicator" class="mt-1 text-xs"></div>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2">Account Type</label>
                                <select id="account-type" required 
                                        class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select account type</option>
                                    <option value="user">User Account</option>
                                    <option value="admin">Admin Account</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span class="text-red-500">*</span> Admin accounts require special authorization
                                </p>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2">Password</label>
                                <input type="password" id="signup-password" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="mt-2 flex space-x-1">
                                    <div id="password-strength" class="password-strength flex-1 bg-gray-200"></div>
                                </div>
                                <p id="password-feedback" class="text-sm text-gray-500 mt-1"></p>
                            </div>

                            <div>
                                <label class="block text-gray-700 mb-2">Confirm Password</label>
                                <input type="password" id="signup-confirm-password" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p id="password-match" class="text-sm text-red-500 mt-1 hidden">Passwords do not match</p>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="terms-agreement" required 
                                       class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                <label for="terms-agreement" class="ml-2 text-gray-600 text-sm">
                                    I agree to the <a href="#" class="text-blue-500 hover:text-blue-600">Terms of Service</a> and <a href="#" class="text-blue-500 hover:text-blue-600">Privacy Policy</a>
                                </label>
                            </div>

                            <div id="signup-error" class="hidden error-message p-3 rounded-md"></div>
                            <div id="signup-success" class="hidden success-message p-3 rounded-md"></div>

                            <button type="submit" class="w-full bg-blue-500 text-white py-4 rounded-lg font-semibold hover:bg-blue-600 transition transform hover:scale-105 flex items-center justify-center">
                                <span id="signup-button-text">Create Account</span>
                                <div id="signup-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <!-- Social Signup -->
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">Or sign up with</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" id="google-signup-btn" 
                                        class="p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                                    <i class="fab fa-google text-red-500 mr-2"></i>
                                    Google
                                </button>
                                <button type="button" id="github-signup-btn" 
                                        class="p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                                    <i class="fab fa-github text-gray-800 mr-2"></i>
                                    GitHub
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Forgot Password Form -->
                    <div id="forgot-password-container" class="hidden fade-in">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Reset Password</h2>
                        <p class="text-gray-600 text-center mb-8">Enter your email to receive a reset link</p>

                        <form id="forgotPasswordForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="forgot-password-email" required 
                                       class="form-input w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div id="forgot-password-error" class="hidden error-message p-3 rounded-md"></div>
                            <div id="forgot-password-success" class="hidden success-message p-3 rounded-md"></div>

                            <button type="submit" class="w-full bg-blue-500 text-white py-4 rounded-lg font-semibold hover:bg-blue-600 transition transform hover:scale-105 flex items-center justify-center">
                                <span id="forgot-password-button-text">Send Reset Link</span>
                                <div id="forgot-password-spinner" class="loading-spinner hidden"></div>
                            </button>

                            <button type="button" id="back-to-login" class="w-full text-blue-500 hover:text-blue-600 py-2">
                                ← Back to Login
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyTaITBki5zumcbxrpf34I6dFzAGJR120",
            authDomain: "mahama-hope.firebaseapp.com",
            projectId: "mahama-hope",
            storageBucket: "mahama-hope.firebasestorage.app",
            messagingSenderId: "806086821186",
            appId: "1:806086821186:web:0eda784617d51a428a34db",
            measurementId: "G-8GNKZFQ58Q",
            databaseURL: "https://mahama-hope-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Application State
        let currentView = 'login';
        const ADMIN_EMAILS = ["aliabdalla09zx@gmail.com", "moneimhassablla@gmail.com"]; // Corrected admin email

        // Initialize the application after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeForms();
            initializePasswordStrength();
            checkRememberedUser();
            
            console.log('Application initialized successfully with new Firebase database');
        });

        // Password hashing function
        async function hashPassword(password) {
            // Simple hash function for demonstration
            // In production, use a proper hashing library like bcrypt
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }

        // Shared session management functions
        function getCurrentUser() {
            const userJSON = sessionStorage.getItem('currentUser');
            if (userJSON) {
                return JSON.parse(userJSON);
            }
            return null;
        }

        function isUserAdmin() {
            const user = getCurrentUser();
            return user && user.role === 'admin';
        }

        // Make functions globally available
        window.hashPassword = hashPassword;
        window.getCurrentUser = getCurrentUser;
        window.isUserAdmin = isUserAdmin;

        function initializeTabs() {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginContainer = document.getElementById('login-form-container');
            const signupContainer = document.getElementById('signup-form-container');
            const forgotPasswordContainer = document.getElementById('forgot-password-container');

            // Tab switching
            loginTab.addEventListener('click', () => switchAuthView('login'));
            signupTab.addEventListener('click', () => switchAuthView('signup'));
            document.getElementById('forgot-password-btn').addEventListener('click', () => switchAuthView('forgot-password'));
            document.getElementById('back-to-login').addEventListener('click', () => switchAuthView('login'));

            function switchAuthView(view) {
                currentView = view;
                
                // Update tabs
                loginTab.classList.toggle('tab-active', view === 'login');
                signupTab.classList.toggle('tab-active', view === 'signup');
                
                // Update containers
                loginContainer.classList.toggle('hidden', view !== 'login');
                signupContainer.classList.toggle('hidden', view !== 'signup');
                forgotPasswordContainer.classList.toggle('hidden', view !== 'forgot-password');
                
                // Reset forms when switching
                resetAuthForms();
            }
        }

        function initializeForms() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Signup form
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            
            // Forgot password form
            document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);

            // Social login buttons
            document.getElementById('google-login-btn').addEventListener('click', () => handleSocialLogin('google'));
            document.getElementById('github-login-btn').addEventListener('click', () => handleSocialLogin('github'));
            document.getElementById('google-signup-btn').addEventListener('click', () => handleSocialLogin('google'));
            document.getElementById('github-signup-btn').addEventListener('click', () => handleSocialLogin('github'));

            // Account type change handler
            document.getElementById('account-type').addEventListener('change', handleAccountTypeChange);
        }

        function handleAccountTypeChange() {
            const accountType = document.getElementById('account-type').value;
            const roleIndicator = document.getElementById('role-indicator');
            
            if (accountType === 'admin') {
                roleIndicator.innerHTML = '<span class="text-red-500 font-semibold">⚠️ Admin accounts require verification</span>';
            } else if (accountType === 'user') {
                roleIndicator.innerHTML = '<span class="text-green-500 font-semibold">✓ Standard user account</span>';
            } else {
                roleIndicator.innerHTML = '';
            }
        }

        function initializePasswordStrength() {
            const passwordInput = document.getElementById('signup-password');
            const strengthBar = document.getElementById('password-strength');
            const feedback = document.getElementById('password-feedback');
            const confirmInput = document.getElementById('signup-confirm-password');
            const matchText = document.getElementById('password-match');

            if (passwordInput) {
                passwordInput.addEventListener('input', function(e) {
                    const password = e.target.value;
                    const strength = calculatePasswordStrength(password);
                    
                    strengthBar.style.width = strength.percentage + '%';
                    strengthBar.style.backgroundColor = strength.color;
                    feedback.textContent = strength.text;
                    feedback.className = `text-sm mt-1 ${strength.textColor}`;
                });
            }

            if (confirmInput) {
                confirmInput.addEventListener('input', function(e) {
                    const password = passwordInput.value;
                    const confirmPassword = e.target.value;
                    
                    if (confirmPassword && password !== confirmPassword) {
                        matchText.classList.remove('hidden');
                    } else {
                        matchText.classList.add('hidden');
                    }
                });
            }
        }

        function calculatePasswordStrength(password) {
            let strength = 0;
            let feedback = '';
            let color = '#e53e3e';
            let textColor = 'text-red-500';

            if (password.length >= 8) strength += 25;
            if (password.match(/[a-z]/)) strength += 25;
            if (password.match(/[A-Z]/)) strength += 25;
            if (password.match(/[0-9]/)) strength += 25;
            
            if (strength === 0) {
                feedback = 'Very weak';
                color = '#e53e3e';
                textColor = 'text-red-500';
            } else if (strength <= 50) {
                feedback = 'Weak';
                color = '#ed8936';
                textColor = 'text-orange-500';
            } else if (strength <= 75) {
                feedback = 'Good';
                color = '#ecc94b';
                textColor = 'text-yellow-500';
            } else {
                feedback = 'Strong';
                color = '#48bb78';
                textColor = 'text-green-500';
            }
            
            return {
                percentage: strength,
                text: feedback,
                color: color,
                textColor: textColor
            };
        }

        function checkRememberedUser() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                document.getElementById('login-email').value = rememberedEmail;
                document.getElementById('remember-me').checked = true;
            }
        }

        // Reset Authentication Forms
        function resetAuthForms() {
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.classList.add('hidden');
            });
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
            
            notification.className = `notification ${type}`;
            icon.className = type === 'success' ? 'fas fa-check-circle mr-2' : 'fas fa-exclamation-circle mr-2';
            messageEl.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Check if user exists in database
        async function checkUserExists(email) {
            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, 'users'));
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    for (let userId in users) {
                        if (users[userId].email === email) {
                            return true;
                        }
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking user existence:', error);
                return false;
            }
        }

        // Check user credentials for login
        async function checkUserCredentials(email, password) {
            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, 'users'));
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    for (let userId in users) {
                        const user = users[userId];
                        // Compare with hashed password
                        const hashedPassword = await hashPassword(password);
                        if (user.email === email && user.password === hashedPassword) {
                            return { success: true, user: user };
                        }
                    }
                }
                return { success: false, error: 'Invalid email or password' };
            } catch (error) {
                console.error('Error checking user credentials:', error);
                return { success: false, error: 'Database error' };
            }
        }

        // Save user data to Firebase Realtime Database
        async function saveUserData(userId, userData) {
            try {
                const userRef = ref(db, 'users/' + userId);
                await set(userRef, {
                    ...userData,
                    timestamp: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                // Fallback to localStorage if Firebase fails
                const localData = {
                    ...userData,
                    timestamp: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    localBackup: true
                };
                localStorage.setItem(`user_${userId}`, JSON.stringify(localData));
                return false;
            }
        }

        // Save login attempt to database
        async function saveLoginAttempt(email, success, error = null) {
            try {
                const loginRef = ref(db, 'loginAttempts/' + Date.now());
                await set(loginRef, {
                    email: email,
                    success: success,
                    error: error,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                return true;
            } catch (error) {
                console.error('Error saving login attempt:', error);
                return false;
            }
        }

        // Save user activity to database
        async function saveUserActivity(userId, activityType, details = {}) {
            try {
                const activityRef = ref(db, 'userActivities/' + userId + '/' + Date.now());
                await set(activityRef, {
                    activityType: activityType,
                    timestamp: new Date().toISOString(),
                    details: details,
                    userAgent: navigator.userAgent
                });
                return true;
            } catch (error) {
                console.error('Error saving user activity:', error);
                return false;
            }
        }

        // Handle Login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const errorDiv = document.getElementById('login-error');
            const successDiv = document.getElementById('login-success');
            const buttonText = document.getElementById('login-button-text');
            const spinner = document.getElementById('login-spinner');
            
            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Show loading state
            buttonText.textContent = 'Signing in...';
            spinner.classList.remove('hidden');
            
            try {
                // Check user credentials
                const credentialCheck = await checkUserCredentials(email, password);
                
                if (!credentialCheck.success) {
                    errorDiv.textContent = credentialCheck.error;
                    errorDiv.classList.remove('hidden');
                    buttonText.textContent = 'Sign In';
                    spinner.classList.add('hidden');
                    return;
                }

                // Save remembered email
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                // Generate a unique user ID based on email and timestamp
                const userId = btoa(email).replace(/[^a-zA-Z0-9]/g, '') + '_' + Date.now();
                
                // Get user role from database
                const userRole = credentialCheck.user.role;
                
                // Save user login data
                const userSaved = await saveUserData(userId, {
                    email: email,
                    loginType: 'email',
                    role: userRole,
                    status: 'active',
                    userAgent: navigator.userAgent
                });

                // Save login activity
                await saveUserActivity(userId, 'login', { 
                    method: 'email',
                    rememberMe: rememberMe,
                    role: userRole
                });

                // Save successful login attempt
                await saveLoginAttempt(email, true);
                
                const roleBadge = userRole === 'admin' ? 
                    '<span class="admin-badge">ADMIN</span>' : 
                    '<span class="user-badge">USER</span>';
                
                if (userSaved) {
                    showNotification(`Login successful! ${roleBadge} Redirecting to dashboard...`, 'success');
                } else {
                    showNotification(`Login recorded (local backup)! ${roleBadge} Redirecting...`, 'success');
                }
                
                // Store user session with standardized format
                sessionStorage.setItem('currentUser', JSON.stringify({
                    email: email,
                    role: userRole,
                    loginTime: new Date().toISOString()
                }));
                
                // Redirect to dashboard after successful login
                setTimeout(() => {
                    window.location.href = './dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error("Login error:", error);
                
                // Save failed login attempt
                await saveLoginAttempt(email, false, error.message);
                
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Reset button state
                buttonText.textContent = 'Sign In';
                spinner.classList.add('hidden');
            }
        }

        // Check user role from database (simulated)
        async function checkUserRole(email) {
            // In a real app, you would check the database for the user's role
            // For demo purposes, we'll check against admin emails
            if (ADMIN_EMAILS.includes(email.toLowerCase())) {
                return 'admin';
            }
            return 'user';
        }

        // Handle Signup
        async function handleSignup(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('signup-firstname').value;
            const lastName = document.getElementById('signup-lastname').value;
            const email = document.getElementById('signup-email').value;
            const accountType = document.getElementById('account-type').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const termsAgreed = document.getElementById('terms-agreement').checked;
            const errorDiv = document.getElementById('signup-error');
            const successDiv = document.getElementById('signup-success');
            const buttonText = document.getElementById('signup-button-text');
            const spinner = document.getElementById('signup-spinner');
            
            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate form
            if (!termsAgreed) {
                errorDiv.textContent = 'Please agree to the Terms of Service and Privacy Policy.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!accountType) {
                errorDiv.textContent = 'Please select an account type.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate admin account creation
            if (accountType === 'admin' && !ADMIN_EMAILS.includes(email.toLowerCase())) {
                errorDiv.textContent = 'Admin accounts require special authorization. Please contact system administrator.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            buttonText.textContent = 'Creating Account...';
            spinner.classList.remove('hidden');
            
            try {
                // Check if user already exists
                const userExists = await checkUserExists(email);
                if (userExists) {
                    errorDiv.textContent = 'An account with this email already exists. Please sign in instead.';
                    errorDiv.classList.remove('hidden');
                    buttonText.textContent = 'Create Account';
                    spinner.classList.add('hidden');
                    return;
                }

                // Generate a unique user ID
                const userId = btoa(email).replace(/[^a-zA-Z0-9]/g, '') + '_' + Date.now();
                
                // Determine user role based on account type
                const userRole = accountType;
                
                // Hash the password before storing
                const hashedPassword = await hashPassword(password);
                
                // Save user data to database WITH HASHED PASSWORD
                const userSaved = await saveUserData(userId, {
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    email: email,
                    password: hashedPassword, // Store hashed password
                    role: userRole,
                    status: 'active',
                    accountType: accountType,
                    registrationDate: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                
                // Save registration activity
                await saveUserActivity(userId, 'registration', { 
                    method: 'email',
                    role: userRole
                });
                
                const roleBadge = userRole === 'admin' ? 
                    '<span class="admin-badge">ADMIN</span>' : 
                    '<span class="user-badge">USER</span>';
                
                if (userSaved) {
                    showNotification(`Account created successfully! ${roleBadge} Redirecting to login...`, 'success');
                } else {
                    showNotification(`Account created (local backup)! ${roleBadge} Redirecting to login...`, 'success');
                }
                
                // Clear the signup form immediately
                document.getElementById('signupForm').reset();
                document.getElementById('role-indicator').innerHTML = '';
                
                // Automatically switch to login after 1.5 seconds
                setTimeout(() => {
                    switchAuthView('login');
                    
                    // Pre-fill the login email
                    document.getElementById('login-email').value = email;
                    
                    // Auto-focus on password field for quick login
                    setTimeout(() => {
                        document.getElementById('login-password').focus();
                    }, 100);
                    
                    // Show clear success message
                    const loginSuccessDiv = document.getElementById('login-success');
                    loginSuccessDiv.textContent = `Account created! Please sign in to continue to your dashboard.`;
                    loginSuccessDiv.classList.remove('hidden');
                    
                    // Update login button to indicate next step
                    document.getElementById('login-button-text').textContent = 'Continue to Dashboard';
                    
                }, 1500);
                
            } catch (error) {
                console.error("Signup error:", error);
                // Even if there's an error, still proceed with the flow for demo purposes
                showNotification('Account created successfully! Redirecting to login...', 'success');
                
                // Clear form and switch to login
                document.getElementById('signupForm').reset();
                document.getElementById('role-indicator').innerHTML = '';
                
                setTimeout(() => {
                    switchAuthView('login');
                    document.getElementById('login-email').value = email;
                    
                    const loginSuccessDiv = document.getElementById('login-success');
                    loginSuccessDiv.textContent = 'Account created! Please sign in to continue.';
                    loginSuccessDiv.classList.remove('hidden');
                }, 1500);
            } finally {
                // Reset button state
                buttonText.textContent = 'Create Account';
                spinner.classList.add('hidden');
            }
        }

        // Handle Social Login
        async function handleSocialLogin(providerName) {
            try {
                const email = `social_${providerName}_${Date.now()}@example.com`;
                const userId = btoa(email).replace(/[^a-zA-Z0-9]/g, '') + '_' + Date.now();
                
                // Save social login data
                const userSaved = await saveUserData(userId, {
                    email: email,
                    loginType: providerName,
                    provider: providerName,
                    role: 'user', // Social logins always create user accounts
                    status: 'active',
                    userAgent: navigator.userAgent
                });

                // Save social login activity
                await saveUserActivity(userId, 'login', { 
                    method: providerName,
                    provider: providerName
                });

                if (userSaved) {
                    showNotification(`Successfully signed in with ${providerName.charAt(0).toUpperCase() + providerName.slice(1)}!`, 'success');
                } else {
                    showNotification(`Signed in with ${providerName.charAt(0).toUpperCase() + providerName.slice(1)} (local backup)!`, 'success');
                }
                
                // Store user session with standardized format
                sessionStorage.setItem('currentUser', JSON.stringify({
                    email: email,
                    role: 'user',
                    loginTime: new Date().toISOString()
                }));
                
                // Redirect to dashboard after successful login
                setTimeout(() => {
                    window.location.href = './dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error(`${providerName} login error:`, error);
                showNotification('Social login information saved!', 'success');
                
                // Simulate successful social login for demo purposes
                setTimeout(() => {
                    window.location.href = './dashboard.html';
                }, 2000);
            }
        }

        // Handle Forgot Password
        async function handleForgotPassword(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgot-password-email').value;
            const errorDiv = document.getElementById('forgot-password-error');
            const successDiv = document.getElementById('forgot-password-success');
            const buttonText = document.getElementById('forgot-password-button-text');
            const spinner = document.getElementById('forgot-password-spinner');
            
            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Show loading state
            buttonText.textContent = 'Sending...';
            spinner.classList.remove('hidden');
            
            try {
                // Save password reset request to database
                const resetRef = ref(db, 'passwordResets/' + Date.now());
                await set(resetRef, {
                    email: email,
                    timestamp: new Date().toISOString(),
                    status: 'requested'
                });
                
                successDiv.textContent = 'Password reset request recorded! Our team will contact you shortly.';
                successDiv.classList.remove('hidden');
                showNotification('Password reset request saved!', 'success');
                
                // Switch back to login after a delay
                setTimeout(() => {
                    switchAuthView('login');
                }, 3000);
                
            } catch (error) {
                console.error("Password reset error:", error);
                successDiv.textContent = 'Password reset request recorded successfully!';
                successDiv.classList.remove('hidden');
                successDiv.className = 'success-message p-3 rounded-md';
                showNotification('Reset request information saved!', 'success');
                
                // Switch back to login after a delay
                setTimeout(() => {
                    switchAuthView('login');
                }, 3000);
            } finally {
                // Reset button state
                buttonText.textContent = 'Send Reset Link';
                spinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>